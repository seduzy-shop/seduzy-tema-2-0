{{ 'advanced-reviews.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }
  .advanced-reviews-{{ section.id }} {
    --reviews-primary-color: {{ section.settings.primary_color }};
    --reviews-star-color: {{ section.settings.star_color }};
    --reviews-bg-color: {{ section.settings.section_bg_color }};
    --reviews-card-bg: {{ section.settings.card_bg_color }};
    --reviews-text-color: {{ section.settings.text_color }};
    --reviews-border-color: {{ section.settings.border_color }};
    --reviews-card-radius: {{ section.settings.card_radius }}px;
    --grid-columns: {{ section.settings.desktop_columns }};
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  /* Controle de Visibilidade */
  .review-card.is-hidden { display: none !important; }
  .load-more-box.is-hidden { display: none !important; }
{%- endstyle -%}

{%- assign reviews_data = product.metafields.custom.reviews_json.value | default: product.metafields.custom.reviews_do_produto.value -%}

{%- if reviews_data and reviews_data.size > 0 -%}
  {%- assign total_reviews = reviews_data.size -%}
  {%- assign total_rating = 0 -%}
  {%- assign stars_5 = 0 -%} {%- assign stars_4 = 0 -%} {%- assign stars_3 = 0 -%} {%- assign stars_2 = 0 -%} {%- assign stars_1 = 0 -%}
  {%- assign reviews_with_images_count = 0 -%}
  {%- assign all_images_list = '' -%}

  {%- for review in reviews_data -%}
    {%- assign r_note = review.rating | default: review.nota | plus: 0 -%}
    {%- assign total_rating = total_rating | plus: r_note -%}
    {%- assign rounded = r_note | round -%}
    {%- case rounded -%}
      {%- when 5 -%}{%- assign stars_5 = stars_5 | plus: 1 -%}
      {%- when 4 -%}{%- assign stars_4 = stars_4 | plus: 1 -%}
      {%- when 3 -%}{%- assign stars_3 = stars_3 | plus: 1 -%}
      {%- when 2 -%}{%- assign stars_2 = stars_2 | plus: 1 -%}
      {%- when 1 -%}{%- assign stars_1 = stars_1 | plus: 1 -%}
    {%- endcase -%}
    {%- assign r_img = review.imagem | default: review.image -%}
    {%- if r_img != blank -%}
        {%- assign reviews_with_images_count = reviews_with_images_count | plus: 1 -%}
        {%- if all_images_list == '' -%}
            {%- assign all_images_list = r_img -%}
        {%- else -%}
            {%- assign all_images_list = all_images_list | append: ',' | append: r_img -%}
        {%- endif -%}
    {%- endif -%}
  {%- endfor -%}

  {%- assign average_rating = total_rating | times: 1.0 | divided_by: total_reviews -%}

  <div class="advanced-reviews advanced-reviews-{{ section.id }} section-{{ section.id }}-padding" 
       id="reviews-section" 
       data-all-images="{{ all_images_list }}"
       data-initial-limit="{{ section.settings.initial_reviews_limit }}">
    <div class="page-width">
      
      {%- comment %} HEADER {% endcomment -%}
      <div class="reviews-modern-top">
        <div class="summary-section">
          <div class="summary-flex">
            <div class="rating-big">{{ average_rating | round: 1 }}</div>
            <div class="summary-info">
              <div class="stars-main">
                {%- assign full_stars = average_rating | floor -%}
                {%- assign decimal = average_rating | minus: full_stars -%}
                {%- assign next_star = full_stars | plus: 1 -%}
                {%- for i in (1..5) -%}
                  {%- if i <= full_stars -%}<span class="star-f">‚òÖ</span>
                  {%- elsif decimal >= 0.25 and i == next_star -%}<span class="star-h">‚òÖ</span>
                  {%- else -%}<span class="star-e">‚òÖ</span>{%- endif -%}
                {%- endfor -%}
              </div>
              <span class="count-txt">{{ total_reviews }} {{ section.settings.opinions_text }}</span>
            </div>
          </div>
          
          <div class="dist-bars">
            {%- assign levels = "5,4,3,2,1" | split: ',' -%}
            {%- for level in levels -%}
              {%- assign c = 0 -%}
              {%- if level == "5" -%}{%- assign c = stars_5 -%}{%- elsif level == "4" -%}{%- assign c = stars_4 -%}{%- elsif level == "3" -%}{%- assign c = stars_3 -%}{%- elsif level == "2" -%}{%- assign c = stars_2 -%}{%- elsif level == "1" -%}{%- assign c = stars_1 -%}{%- endif -%}
              {%- assign p = c | times: 100 | divided_by: total_reviews -%}
              <div class="bar-row">
                <span>{{ level }}</span> <span class="mini-star">‚òÖ</span>
                <div class="track"><div class="fill" style="width:{{ p }}%"></div></div>
                <span class="row-val">{{ c }}</span>
              </div>
            {%- endfor -%}
          </div>
        </div>

        {%- if section.settings.show_photos_gallery and reviews_with_images_count > 0 -%}
          <div class="gallery-section">
            <h3 class="gallery-title">{{ section.settings.photos_title }}</h3>
            <div class="horizontal-media" id="header-gallery">
              {%- assign img_index = 0 -%}
              {%- for review in reviews_data -%}
                {%- assign r_img = review.imagem | default: review.image -%}
                {%- if r_img != blank -%}
                  <div class="media-thumb">
                    <img src="{{ r_img }}" loading="lazy" data-index="{{ img_index }}" class="gallery-trigger">
                  </div>
                  {%- assign img_index = img_index | plus: 1 -%}
                {%- endif -%}
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}
      </div>

      <div class="actions-row">
        {%- if section.settings.show_write_review_btn -%}
          <button class="btn-write" id="btn-write-review">{{ section.settings.write_review_text }}</button>
        {%- endif -%}
      </div>

      <div class="modern-grid masonry-layout" id="reviews-grid-main">
        {%- assign display_counter = 0 -%}
        
        {%- comment %} REVIEWS COM FOTO (PRIORIDADE) {% endcomment -%}
        {%- for review in reviews_data -%}
          {%- assign r_img = review.imagem | default: review.image -%}
          {%- if r_img != blank -%}
            {%- assign display_counter = display_counter | plus: 1 -%}
            <div class="modern-card review-card {% if display_counter > section.settings.initial_reviews_limit %}is-hidden{% endif %}" data-index="{{ display_counter }}">
              <div class="card-img-box"><img src="{{ r_img }}" loading="lazy"></div>
              <div class="card-body">
                <div class="user-info">
                  {%- if section.settings.show_avatars -%}<span class="avatar">{{ review.nome | slice: 0 | upcase }}</span>{%- endif -%}
                  <span class="name">{{ review.nome }}</span>
                  {%- if review.verificado or review.verified -%}
                    <svg class="verified-icon" viewBox="0 0 24 24" width="14" height="14" fill="#22c55e"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                  {%- endif -%}
                </div>
                <div class="card-stars-row">
                  <div class="stars">
                    {%- assign r_val = review.rating | default: review.nota | plus: 0 -%}
                    {%- for i in (1..5) -%}
                      {%- if i <= r_val -%}‚òÖ{%- else -%}‚òÜ{%- endif -%}
                    {%- endfor -%}
                  </div>
                </div>
                <p class="text">{{ review.texto | default: review.review }}</p>
                <div class="card-footer">
                  <span class="card-date">{{ review.data | default: review.date }}</span>
                  {%- if section.settings.show_helpful_button -%}<button class="btn-like">üëç 0</button>{%- endif -%}
                </div>
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}

        {%- comment %} REVIEWS SEM FOTO {% endcomment -%}
        {%- for review in reviews_data -%}
          {%- assign r_img = review.imagem | default: review.image -%}
          {%- if r_img == blank -%}
            {%- assign display_counter = display_counter | plus: 1 -%}
            <div class="modern-card review-card {% if display_counter > section.settings.initial_reviews_limit %}is-hidden{% endif %}" data-index="{{ display_counter }}">
              <div class="card-body">
                <div class="user-info">
                  {%- if section.settings.show_avatars -%}<span class="avatar">{{ review.nome | slice: 0 | upcase }}</span>{%- endif -%}
                  <span class="name">{{ review.nome }}</span>
                </div>
                <div class="card-stars-row">
                  <div class="stars">
                    {%- assign r_val = review.rating | default: review.nota | plus: 0 -%}
                    {%- for i in (1..5) -%}
                      {%- if i <= r_val -%}‚òÖ{%- else -%}‚òÜ{%- endif -%}
                    {%- endfor -%}
                  </div>
                </div>
                <p class="text">{{ review.texto | default: review.review }}</p>
                <div class="card-footer">
                  <span class="card-date">{{ review.data | default: review.date }}</span>
                  {%- if section.settings.show_helpful_button -%}<button class="btn-like">üëç 0</button>{%- endif -%}
                </div>
              </div>
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
      
      <div class="load-more-box {% if total_reviews <= section.settings.initial_reviews_limit %}is-hidden{% endif %}">
        <button class="btn-load" id="btn-load-more">{{ section.settings.load_more_text }}</button>
      </div>
    </div>
  </div>

  {%- comment %} MODAL GALERIA {% endcomment -%}
  <div class="review-modal" id="review-gallery-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <button class="modal-close">√ó</button>
        <div class="modal-image-wrapper">
            <img src="" alt="Review Image" class="modal-current-image">
        </div>
        <button class="modal-nav modal-prev">‚Äπ</button>
        <button class="modal-nav modal-next">‚Ä∫</button>
    </div>
  </div>

  <script src="{{ 'advanced-reviews.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

{% schema %}
{
  "name": "Reviews Avan√ßados",
  "settings": [
    { "type": "header", "content": "Pagina√ß√£o" },
    { "type": "range", "id": "initial_reviews_limit", "min": 2, "max": 20, "step": 1, "label": "Cards iniciais", "default": 4 },
    { "type": "header", "content": "Layout" },
    { "type": "range", "id": "desktop_columns", "min": 2, "max": 5, "step": 1, "label": "Colunas no Desktop", "default": 4 },
    { "type": "range", "id": "card_radius", "min": 0, "max": 40, "step": 2, "unit": "px", "label": "Arredondamento dos Cards", "default": 16 },
    { "type": "header", "content": "Cores" },
    { "type": "color", "id": "primary_color", "label": "Cor Bot√µes", "default": "#1a1a1a" },
    { "type": "color", "id": "star_color", "label": "Cor Estrelas", "default": "#FFC107" },
    { "type": "color", "id": "section_bg_color", "label": "Fundo Se√ß√£o", "default": "#F9F9F9" },
    { "type": "color", "id": "card_bg_color", "label": "Fundo Cards", "default": "#FFFFFF" },
    { "type": "color", "id": "text_color", "label": "Cor Texto", "default": "#1a1a1a" },
    { "type": "color", "id": "border_color", "label": "Cor Bordas", "default": "#E5E5E5" },
    { "type": "header", "content": "Textos" },
    { "type": "text", "id": "opinions_text", "label": "Texto 'opini√µes'", "default": "opini√µes" },
    { "type": "text", "id": "photos_title", "label": "T√≠tulo Galeria", "default": "Todas as m√≠dias" },
    { "type": "text", "id": "write_review_text", "label": "Bot√£o Avaliar", "default": "Avalie tamb√©m" },
    { "type": "text", "id": "load_more_text", "label": "Bot√£o Carregar", "default": "Ver mais avalia√ß√µes" },
    { "type": "header", "content": "Exibi√ß√£o" },
    { "type": "checkbox", "id": "show_photos_gallery", "label": "Mostrar Galeria Topo", "default": true },
    { "type": "checkbox", "id": "show_write_review_btn", "label": "Mostrar Bot√£o Avaliar", "default": true },
    { "type": "checkbox", "id": "show_helpful_button", "label": "Mostrar Bot√£o '√ötil'", "default": true },
    { "type": "checkbox", "id": "show_avatars", "label": "Mostrar Iniciais/Avatares", "default": true },
    { "type": "header", "content": "Espa√ßamento" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Superior", "default": 40 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 100, "step": 4, "unit": "px", "label": "Inferior", "default": 40 }
  ],
  "presets": [{ "name": "Reviews Avan√ßados" }]
}
{% endschema %}