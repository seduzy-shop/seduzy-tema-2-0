{% comment %}
============================================================
üß≠ Popup Newsletter - Warehouse Theme Compatible
------------------------------------------------------------
‚úÖ Usa {% form 'customer' %} nativo do Shopify
‚úÖ Salva nome e e-mail corretamente
‚úÖ Mostra cupom ap√≥s cadastro
‚úÖ Design responsivo e profissional
============================================================
{% endcomment %}

{% if section.settings.enable_popup %}
<!-- Overlay do popup -->
<div id="popup-overlay" class="popup-overlay" style="display: none;">
  <div id="newsletter-popup" class="popup-content">
    <span class="popup-close">&times;</span>

    <!-- Banner opcional -->
    {% if section.settings.popup_banner != blank %}
      <div class="popup-banner">
        <img src="{{ section.settings.popup_banner | img_url: '600x' }}" alt="Banner" class="popup-banner-img">
      </div>
    {% endif %}

    <div id="popup-form-container">
      <!-- T√≠tulo e subt√≠tulo -->
      <h3 class="popup-title" style="color: {{ section.settings.popup_title_color }};">
        {{ section.settings.popup_title }}
      </h3>
      <p class="popup-subtitle">{{ section.settings.popup_subtitle }}</p>

      <!-- Formul√°rio Shopify nativo -->
      {% form 'customer', id: 'newsletter-popup-form', class: 'popup-form' %}
        {% if form.posted_successfully? %}
          <!-- Formul√°rio enviado com sucesso - JavaScript vai detectar isso -->
          <script>
            if (typeof window !== 'undefined') {
              localStorage.setItem('popupJustCompleted', 'true');
              localStorage.setItem('popupCompleted', Date.now());
            }
          </script>
        {% endif %}
        
        <input type="hidden" name="contact[tags]" value="newsletter">
        
        <!-- Campo Nome -->
        <div class="form__input-wrapper">
          <input 
            type="text" 
            name="contact[first_name]" 
            id="popup-name"
            placeholder="{{ section.settings.name_placeholder }}"
            required
            class="popup-input"
          >
        </div>
        
        <!-- Campo E-mail -->
        <div class="form__input-wrapper">
          <input 
            type="email" 
            name="contact[email]" 
            id="popup-email"
            placeholder="{{ section.settings.email_placeholder }}"
            required
            class="popup-input"
          >
        </div>

        {% if form.errors %}
          <div class="popup-error">
            {{ form.errors | default_errors }}
          </div>
        {% endif %}

        <button type="submit" class="popup-btn" id="popup-submit-btn">
          {{ section.settings.popup_button_text }}
        </button>
      {% endform %}

      <a href="#" id="popup-decline" class="popup-decline">
        {{ section.settings.popup_decline_text }}
      </a>
    </div>

    <!-- Tela de agradecimento (escondida inicialmente) -->
    <div id="popup-thankyou" style="display: none;">
      <h3 class="popup-title" style="color: {{ section.settings.popup_title_color }};">
        {{ section.settings.thankyou_title }}
      </h3>
      <p class="popup-subtitle">{{ section.settings.thankyou_message }}</p>
      
      <div class="coupon-container">
        <input 
          type="text" 
          readonly 
          value="{{ section.settings.thankyou_coupon }}" 
          id="couponCode" 
          class="coupon-input"
          style="border-color: {{ section.settings.popup_button_color }};"
        >
        <button id="copyCoupon" class="popup-btn copy-btn">
          {{ section.settings.thankyou_button_text }}
        </button>
      </div>
      
      <small class="popup-note">{{ section.settings.thankyou_note }}</small>
    </div>
  </div>
</div>

<!-- Bot√£o lateral -->
{% if section.settings.show_side_button %}
<div id="side-button" class="side-button">
  {{ section.settings.side_button_text }}
</div>
{% endif %}

<!-- Estilos -->
<style>
  .popup-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .popup-content {
    background: {{ section.settings.popup_bg_color }};
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    max-width: 400px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    color: {{ section.settings.popup_text_color }};
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  .popup-banner {
    width: calc(100% + 60px);
    margin: -30px -30px 20px -30px;
  }

  .popup-banner-img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 12px 12px 0 0;
  }

  .popup-close {
    position: absolute;
    right: 15px;
    top: 10px;
    cursor: pointer;
    font-size: 28px;
    line-height: 1;
    z-index: 1;
    color: {{ section.settings.popup_text_color }};
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .popup-close:hover {
    opacity: 1;
  }

  .popup-title {
    margin: 0 0 10px 0;
    font-size: 24px;
    font-weight: 700;
    line-height: 1.3;
  }

  .popup-subtitle {
    margin: 0 0 20px 0;
    font-size: 15px;
    line-height: 1.5;
    opacity: 0.9;
  }

  .popup-form {
    margin: 0;
  }

  .form__input-wrapper {
    margin-bottom: 12px;
  }

  .popup-input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 15px;
    box-sizing: border-box;
    transition: border-color 0.2s;
  }

  .popup-input:focus {
    outline: none;
    border-color: {{ section.settings.popup_button_color }};
  }

  .popup-error {
    background: #fee;
    color: #c33;
    padding: 10px;
    border-radius: 6px;
    font-size: 13px;
    margin-bottom: 12px;
  }

  .popup-btn {
    background: {{ section.settings.popup_button_color }};
    color: #fff;
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 8px;
    font-weight: 700;
    font-size: 16px;
    transition: opacity 0.2s;
  }

  .popup-btn:hover {
    opacity: 0.9;
  }

  .popup-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .popup-decline {
    display: block;
    margin-top: 14px;
    color: #666;
    font-size: 14px;
    text-decoration: none;
    transition: color 0.2s;
  }

  .popup-decline:hover {
    color: #333;
  }

  .coupon-container {
    margin: 24px 0;
  }

  .coupon-input {
    width: 100%;
    padding: 14px;
    text-align: center;
    font-weight: 700;
    font-size: 20px;
    border: 2px dashed {{ section.settings.popup_button_color }};
    border-radius: 6px;
    background: #f9f9f9;
    margin-bottom: 12px;
    letter-spacing: 2px;
  }

  .copy-btn {
    margin-top: 0;
  }

  .popup-note {
    display: block;
    color: #666;
    font-size: 13px;
    margin-top: 16px;
    font-style: italic;
  }

  .side-button {
    position: fixed;
    {% if section.settings.side_button_position_horizontal == "right" %}
      right: 0;
    {% else %}
      left: 0;
    {% endif %}
    {% if section.settings.side_button_position_vertical == "top" %}
      top: 20%;
    {% elsif section.settings.side_button_position_vertical == "middle" %}
      top: 50%;
      transform: translateY(-50%);
    {% else %}
      bottom: 20%;
    {% endif %}
    background: {{ section.settings.side_button_color }};
    color: white;
    padding: 12px 16px;
    writing-mode: vertical-rl;
    text-orientation: mixed;
    border-radius: {% if section.settings.side_button_position_horizontal == "right" %}8px 0 0 8px{% else %}0 8px 8px 0{% endif %};
    cursor: pointer;
    z-index: 9998;
    font-weight: 700;
    font-size: 14px;
    box-shadow: -2px 2px 8px rgba(0,0,0,0.2);
    transition: transform 0.2s;
  }

  .side-button:hover {
    {% if section.settings.side_button_position_vertical == "middle" %}
      transform: translateY(-50%) scale(1.05);
    {% else %}
      transform: scale(1.05);
    {% endif %}
  }

  /* Scrollbar customizada */
  .popup-content::-webkit-scrollbar {
    width: 8px;
  }

  .popup-content::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }

  .popup-content::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
  }

  .popup-content::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  /* Responsivo */
  @media (max-width: 480px) {
    .popup-content {
      padding: 24px;
      width: 95%;
    }

    .popup-title {
      font-size: 20px;
    }

    .popup-banner {
      width: calc(100% + 48px);
      margin: -24px -24px 16px -24px;
    }

    .coupon-input {
      font-size: 18px;
    }
  }
</style>
{% endif %}

<!-- Script -->
{% if section.settings.enable_popup %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const popup = document.getElementById("popup-overlay");
  const closeBtn = document.querySelector(".popup-close");
  const declineBtn = document.getElementById("popup-decline");
  const sideBtn = document.getElementById("side-button");
  const formContainer = document.getElementById("popup-form-container");
  const thankyouContainer = document.getElementById("popup-thankyou");
  const form = document.getElementById("newsletter-popup-form");
  const submitBtn = document.getElementById("popup-submit-btn");

  // Configura√ß√µes
  const delay = parseInt({{ section.settings.popup_delay | default: 8 }}) * 1000;
  const returnDays = parseInt({{ section.settings.popup_return_days | default: 7 }}) * 86400000;

  // Fun√ß√£o para mostrar tela de agradecimento
  function showThankYou() {
    if (formContainer) formContainer.style.display = "none";
    if (thankyouContainer) thankyouContainer.style.display = "block";
    
    // Event listener para copiar cupom
    const copyBtn = document.getElementById("copyCoupon");
    if (copyBtn) {
      copyBtn.addEventListener("click", function() {
        const couponCode = document.getElementById("couponCode");
        couponCode.select();
        couponCode.setSelectionRange(0, 99999);
        
        if (navigator.clipboard) {
          navigator.clipboard.writeText(couponCode.value).then(function() {
            copyBtn.textContent = "‚úì Copiado!";
            setTimeout(function() {
              copyBtn.textContent = "{{ section.settings.thankyou_button_text }}";
            }, 2000);
          });
        } else {
          document.execCommand("copy");
          copyBtn.textContent = "‚úì Copiado!";
          setTimeout(function() {
            copyBtn.textContent = "{{ section.settings.thankyou_button_text }}";
          }, 2000);
        }
      });
    }
  }

  // Verifica se acabou de completar o cadastro
  const justCompleted = localStorage.getItem('popupJustCompleted');
  if (justCompleted === 'true') {
    // Remove a flag
    localStorage.removeItem('popupJustCompleted');
    // Mostra o popup com cupom
    popup.style.display = "flex";
    showThankYou();
  } else {
    // Verifica se j√° cadastrou anteriormente
    const wasCompleted = localStorage.getItem("popupCompleted");
    
    if (wasCompleted) {
      const timeSinceComplete = Date.now() - parseInt(wasCompleted);
      if (timeSinceComplete < returnDays) {
        // J√° cadastrou recentemente, n√£o mostra
        return;
      }
    }
    
    // Mostrar o popup ap√≥s o delay (primeira vez)
    setTimeout(function() {
      const lastDismiss = localStorage.getItem("popupDismissed");
      
      if (!lastDismiss || (Date.now() - parseInt(lastDismiss)) > returnDays) {
        popup.style.display = "flex";
      }
    }, delay);
  }

  // Intercepta o envio do formul√°rio para salvar no localStorage
  if (form && submitBtn) {
    form.addEventListener("submit", function() {
      // Salva que est√° sendo enviado
      localStorage.setItem("popupSubmitting", "true");
      localStorage.setItem("popupCompleted", Date.now());
      
      // Desabilita bot√£o
      submitBtn.disabled = true;
      submitBtn.textContent = "Enviando...";
    });
  }

  // Fechar popup e registrar data
  function closePopup() {
    popup.style.display = "none";
    localStorage.setItem("popupDismissed", Date.now());
  }

  // Eventos de fechamento
  if (closeBtn) {
    closeBtn.addEventListener("click", closePopup);
  }

  if (declineBtn) {
    declineBtn.addEventListener("click", function(e) {
      e.preventDefault();
      closePopup();
    });
  }

  // Fechar ao clicar fora do popup
  popup.addEventListener("click", function(e) {
    if (e.target === popup) {
      closePopup();
    }
  });

  // Reabrir com bot√£o lateral
  if (sideBtn) {
    sideBtn.addEventListener("click", function() {
      // Se j√° cadastrou, mostra o cupom
      if (localStorage.getItem("popupCompleted")) {
        showThankYou();
      }
      popup.style.display = "flex";
    });
  }

  // Fechar com ESC
  document.addEventListener("keydown", function(e) {
    if (e.key === "Escape" && popup.style.display === "flex") {
      closePopup();
    }
  });
});
</script>
{% endif %}

{% schema %}
{
  "name": "Popup Newsletter",
  "settings": [
    {
      "type": "header",
      "content": "‚öôÔ∏è Ativa√ß√£o"
    },
    {
      "type": "checkbox",
      "id": "enable_popup",
      "label": "Ativar popup",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_side_button",
      "label": "Mostrar bot√£o lateral",
      "default": true
    },
    {
      "type": "header",
      "content": "üé® Design do Popup"
    },
    { 
      "type": "image_picker", 
      "id": "popup_banner", 
      "label": "Banner (logo ou imagem)" 
    },
    { 
      "type": "color", 
      "id": "popup_title_color", 
      "label": "Cor do t√≠tulo", 
      "default": "#000000" 
    },
    { 
      "type": "text", 
      "id": "popup_title", 
      "label": "T√≠tulo", 
      "default": "Ganhe 10% de Desconto" 
    },
    { 
      "type": "textarea", 
      "id": "popup_subtitle", 
      "label": "Subt√≠tulo", 
      "default": "Cadastre-se e receba 10% OFF na sua primeira compra!" 
    },
    { 
      "type": "color", 
      "id": "popup_bg_color", 
      "label": "Cor de fundo", 
      "default": "#ffffff" 
    },
    { 
      "type": "color", 
      "id": "popup_text_color", 
      "label": "Cor do texto", 
      "default": "#000000" 
    },
    { 
      "type": "color", 
      "id": "popup_button_color", 
      "label": "Cor do bot√£o", 
      "default": "#000000" 
    },
    {
      "type": "header",
      "content": "üìù Campos do Formul√°rio"
    },
    { 
      "type": "text", 
      "id": "name_placeholder", 
      "label": "Placeholder do nome", 
      "default": "Digite seu nome" 
    },
    { 
      "type": "text", 
      "id": "email_placeholder", 
      "label": "Placeholder do e-mail", 
      "default": "seu@email.com" 
    },
    { 
      "type": "text", 
      "id": "popup_button_text", 
      "label": "Texto do bot√£o", 
      "default": "QUERO DESCONTO" 
    },
    { 
      "type": "text", 
      "id": "popup_decline_text", 
      "label": "Texto de recusa", 
      "default": "N√£o quero desconto" 
    },
    {
      "type": "header",
      "content": "üéâ Tela de Agradecimento"
    },
    { 
      "type": "text", 
      "id": "thankyou_title", 
      "label": "T√≠tulo de agradecimento", 
      "default": "üéâ Parab√©ns! Voc√™ ganhou 10% OFF" 
    },
    { 
      "type": "textarea", 
      "id": "thankyou_message", 
      "label": "Mensagem de agradecimento", 
      "default": "Use o cupom abaixo na sua primeira compra!" 
    },
    { 
      "type": "text", 
      "id": "thankyou_coupon", 
      "label": "C√≥digo do cupom", 
      "default": "BEMVINDO10" 
    },
    { 
      "type": "text", 
      "id": "thankyou_button_text", 
      "label": "Texto do bot√£o de copiar", 
      "default": "COPIAR CUPOM" 
    },
    { 
      "type": "text", 
      "id": "thankyou_note", 
      "label": "Nota inferior", 
      "default": "*V√°lido apenas para primeira compra" 
    },
    {
      "type": "header",
      "content": "‚è±Ô∏è Comportamento"
    },
    { 
      "type": "range",
      "id": "popup_delay", 
      "label": "Tempo para aparecer (segundos)", 
      "min": 0,
      "max": 30,
      "step": 1,
      "default": 8 
    },
    { 
      "type": "range",
      "id": "popup_return_days", 
      "label": "Dias para reaparecer ap√≥s fechar", 
      "min": 1,
      "max": 30,
      "step": 1,
      "default": 7 
    },
    {
      "type": "header",
      "content": "üìç Bot√£o Lateral"
    },
    { 
      "type": "color", 
      "id": "side_button_color", 
      "label": "Cor do bot√£o lateral", 
      "default": "#000000" 
    },
    { 
      "type": "text", 
      "id": "side_button_text", 
      "label": "Texto do bot√£o lateral", 
      "default": "GANHE 10% OFF" 
    },
    { 
      "type": "select", 
      "id": "side_button_position_horizontal", 
      "label": "Posi√ß√£o horizontal", 
      "options": [
        { "value": "right", "label": "Direita" },
        { "value": "left", "label": "Esquerda" }
      ], 
      "default": "right" 
    },
    { 
      "type": "select", 
      "id": "side_button_position_vertical", 
      "label": "Posi√ß√£o vertical", 
      "options": [
        { "value": "top", "label": "Topo (20%)" },
        { "value": "middle", "label": "Meio" },
        { "value": "bottom", "label": "Baixo (20%)" }
      ], 
      "default": "middle" 
    }
  ],
  "presets": [
    { 
      "name": "Popup Newsletter"
    }
  ]
}
{% endschema %}